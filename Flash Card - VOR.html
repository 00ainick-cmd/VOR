<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> CAET Flash Cards ‚Äì Standalone </title>
  <style>
    :root{
      --bg: #f8fafc; /* slate-50 */
      --card: #ffffff;
      --text: #0f172a; /* slate-900 */
      --muted: #64748b; /* slate-500 */
      --border: #e2e8f0; /* slate-200 */
      --ring: #cbd5e1; /* slate-300 */
      --green: #16a34a; /* green-600 */
      --green-50: #ecfdf5;
      --yellow: #f59e0b; /* yellow-500 */
      --yellow-50: #fffbeb;
      --red: #dc2626; /* red-600 */
      --red-50: #fef2f2;
      --shadow: 0 10px 20px rgba(2, 6, 23, 0.06), 0 2px 6px rgba(2, 6, 23, 0.06);
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(to bottom,var(--bg),#fff);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:28px;letter-spacing:-0.01em;display:flex;align-items:center;gap:10px}
    .sparkle{width:24px;height:24px}
    .deck-switch{display:inline-flex;border:1px solid var(--border);border-radius:999px;padding:6px;background:#fff;box-shadow:var(--shadow)}
    .chip{border:1px solid transparent;background:transparent;color:var(--text);padding:6px 12px;border-radius:999px;cursor:pointer}
    .chip.active{background:#111827;color:#fff}

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow)}
    .card h2{margin:0;padding:16px 20px;border-bottom:1px solid var(--border);font-size:18px}
    .card .content{padding:18px 20px}

    .flip{position:relative;height:300px;border-radius:16px;border:1px solid var(--border);background:#fff;cursor:pointer;user-select:none;perspective:1000px}
    .flip-inner{position:relative;height:100%;transform-style:preserve-3d;transition:transform .4s}
    .flip .face{position:absolute;inset:0;display:grid;place-items:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;padding:16px;text-align:center}
    .flip .back{transform:rotateY(180deg)}
    .flip.is-flipped .flip-inner{transform:rotateY(180deg)}

    .meta{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .term{font-size:28px;font-weight:700;margin-top:6px}
    .unit{font-size:14px;color:var(--muted);margin-top:4px}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;margin:4px 4px 0 0}

    .def{max-width:70ch;font-size:18px;line-height:1.4;max-height:180px;overflow:auto;padding-right:8px}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:16px}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-size:14px;cursor:pointer}
    .btn:focus{outline:2px solid var(--ring);outline-offset:2px}
    .btn-outline{background:#fff}
    .btn-primary{background:#111827;color:#fff;border-color:#111827}
    .btn-ghost{background:transparent}

    .btn-green{color:var(--green);border-color:#bbf7d0;background:var(--green-50)}
    .btn-green.active{background:var(--green);color:#fff;border-color:var(--green)}
    .btn-yellow{color:var(--yellow);border-color:#fef3c7;background:var(--yellow-50)}
    .btn-yellow.active{background:var(--yellow);color:#fff;border-color:var(--yellow)}
    .btn-red{color:var(--red);border-color:#fecaca;background:var(--red-50)}
    .btn-red.active{background:var(--red);color:#fff;border-color:var(--red)}

    .list{max-height:330px;overflow:auto;padding-right:6px}
    .list-item{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:10px}
    .list-item .title{font-weight:600}
    .list-item .line{color:var(--muted);font-size:12px;margin-top:6px}

    .bottom{margin-top:20px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff;cursor:pointer}
    .tag.active{background:#111827;color:#fff;border-color:#111827}

    .search{display:flex;align-items:center;gap:10px;margin-top:12px}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}

    .empty{padding:28px;text-align:center;color:var(--muted)}

    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start;gap:12px}
      .row{flex-direction:column;align-items:stretch}
      .def{max-height:150px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        <svg class="sparkle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2l1.9 4.6L18 8l-4.1 1.4L12 14l-1.9-4.6L6 8l4.1-1.4L12 2z"/>
        </svg>
        AEA Interactive Glossary
      </h1>
      <div class="deck-switch" id="deckSwitch">
        <button class="chip active" data-deck="all">All</button>
        <button class="chip" data-deck="easy">Easy <span class="count" data-count="easy"></span></button>
        <button class="chip" data-deck="medium">Medium <span class="count" data-count="medium"></span></button>
        <button class="chip" data-deck="difficult">Difficult <span class="count" data-count="difficult"></span></button>
      </div>
      <button class="btn btn-primary" id="finishSession" style="margin-top:8px;width:100%;max-width:200px;">Finish Session</button>
    </header>

    <section class="card">
      <h2>Study <span class="meta" style="margin-left:8px">[Space: Flip ‚Ä¢ ‚Üê/‚Üí: Prev/Next]</span></h2>
      <div class="content">
        <div class="flip" id="flip">
          <div class="flip-inner" id="flipInner">
            <div class="face front" id="front"></div>
            <div class="face back" id="back"></div>
          </div>
        </div>
        <div class="row">
          <div class="row" id="ratingRow">
            <button class="btn btn-green" id="rateEasy">Easy</button>
            <button class="btn btn-yellow" id="rateMedium">Medium</button>
            <button class="btn btn-red" id="rateDifficult">Difficult</button>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="prev">Prev</button>
            <button class="btn btn-primary" id="next">Next ‚ñ∂</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>List View</h2>
      <div class="content">
        <div class="list" id="list"></div>
      </div>
    </section>

    <section class="card bottom" style="margin-bottom:8px">
      <h2>Filter</h2>
      <div class="content">
        <div class="tags" id="tags"></div>
        <div class="search">
          <input id="search" type="search" placeholder="Search term, definition, unit, or tag" />
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  // ---------- Data (embedded directly ‚Äì no document.write) ----------
  const FIXED_CARDS = [

  {
    "term": "VOR (VHF Omnidirectional Range)",
    "definition": "A ground-based radio navigation system that provides azimuth (bearing) information to aircraft equipped with VOR receiving equipment. VORs transmit in the VHF frequency band between 108.0 and 117.95 MHz, with the last digit always being odd for voice-equipped stations.",
    "analogy": "A lighthouse that sends directional radio beams in all 360 directions, allowing aircraft to determine their position relative to the station.",
    "unit": "VOR Fundamentals",
    "tags": "fundamentals|navigation|radio_nav"
  },
  {
    "term": "VOR Frequency Range",
    "definition": "VOR stations operate in the VHF band from 108.0 to 117.95 MHz. Frequencies are spaced 50 kHz apart. The lowest 200 channels (108.0-111.95 MHz) are shared with ILS localizer frequencies, while 112.0-117.95 MHz is exclusively for VOR use.",
    "analogy": "Think of it like FM radio stations, each VOR has its own unique frequency you tune into.",
    "unit": "VOR Fundamentals",
    "tags": "fundamentals|frequencies|specifications"
  },
  {
    "term": "VOR Radial",
    "definition": "A magnetic bearing FROM a VOR station, expressed in degrees from 001¬∞ to 360¬∞. Radials extend outward from the station like spokes on a wheel. Aircraft use radials to define their position and establish airways.",
    "analogy": "Imagine the VOR station as the center of a clock, with 360 hands (radials) pointing outward in all directions.",
    "unit": "VOR Navigation",
    "tags": "navigation|radials|position"
  },
  {
    "term": "VOR Phase Comparison Principle",
    "definition": "VOR operates by comparing two 30 Hz signals: a reference phase (omnidirectional) and a variable phase (rotates at 1800 RPM). The phase difference between these signals corresponds to the magnetic bearing from the station. The receiver measures this phase difference to determine the radial.",
    "analogy": "Like comparing two synchronized clocks; the time difference tells you your angular position around the VOR station.",
    "unit": "VOR Fundamentals",
    "tags": "fundamentals|theory|phase_comparison"
  },
  {
    "term": "CDI (Course Deviation Indicator)",
    "definition": "The primary navigation instrument displaying VOR information. It shows lateral deviation from a selected course using a vertical needle (left-right). Each dot represents approximately 2¬∞ of deviation or 200 feet per nautical mile from the selected course.",
    "analogy": "Think of it as a visual aid showing how far left or right you are from your desired path, like lane markings on a highway.",
    "unit": "VOR Instruments",
    "tags": "instruments|indicators|navigation"
  },
  {
    "term": "OBS (Omni Bearing Selector)",
    "definition": "A rotating knob on the VOR indicator that allows the pilot to select any of the 360 radials. Rotating the OBS changes the course displayed on the CDI. It's used to select the desired course TO or FROM the VOR station.",
    "analogy": "Like a compass rose you can rotate to choose which direction you want to navigate.",
    "unit": "VOR Instruments",
    "tags": "instruments|controls|navigation"
  },
  {
    "term": "TO/FROM Indicator",
    "definition": "A triangular or arrow-shaped indicator showing whether the selected course will take you TO the VOR station or FROM it. When centered, it indicates which direction of travel on the selected radial. A blank or OFF flag indicates unreliable or no signal.",
    "analogy": "Like a compass showing whether you're heading toward or away from your destination.",
    "unit": "VOR Instruments",
    "tags": "instruments|indicators|navigation"
  },
  {
    "term": "VOR Station Identification",
    "definition": "Each VOR transmits a unique three-letter Morse code identifier every 10 seconds or less, and may include voice identification. Technicians must verify the identifier before using the station for navigation. A T-E-S-T code or absence of identification indicates the station is unreliable.",
    "analogy": "Like a station ID on a radio broadcast, ensuring you're tuned to the correct navigation facility.",
    "unit": "VOR Operations",
    "tags": "operations|identification|safety"
  },
  {
    "term": "VOR Service Volumes",
    "definition": "VORs are classified by power output and designated service volume: Terminal (T) 25 NM up to 12,000 ft, Low (L) 40 NM up to 18,000 ft, and High (H) 40 NM up to 14,500 ft, 100 NM from 14,500 to 60,000 ft, and 130 NM from 60,000 to FL450.",
    "analogy": "Like cell phone coverage zones - stronger towers reach farther and higher.",
    "unit": "VOR Operations",
    "tags": "operations|service_volume|coverage"
  },
  {
    "term": "VOR Accuracy Standard",
    "definition": "VOR ground stations must maintain bearing accuracy within ¬±1¬∞ under normal conditions. Airborne VOR receivers must be accurate within ¬±4¬∞ when tested using a VOT (VOR Test Facility), VOR checkpoint, or airborne checkpoint.",
    "analogy": "Like ensuring a compass is properly calibrated - small errors multiply over long distances.",
    "unit": "VOR Testing",
    "tags": "testing|accuracy|standards"
  },
  {
    "term": "VOT (VOR Test Facility)",
    "definition": "A ground-based test facility that transmits a 360¬∞ radial (or 180¬∞ in some cases) for VOR receiver testing. When tuned to the VOT frequency, the CDI should center on 360¬∞ (or 180¬∞) with a FROM indication (or TO for 180¬∞). Tolerance is ¬±4¬∞.",
    "analogy": "Like a calibration station for your navigation equipment, providing a known reference signal.",
    "unit": "VOR Testing",
    "tags": "testing|maintenance|calibration"
  },
  {
    "term": "VORTAC",
    "definition": "A navigation facility combining VOR (for civilian use) and TACAN (Tactical Air Navigation for military) at the same location. It provides both azimuth information (VOR) and distance information (DME/TACAN) to equipped aircraft.",
    "analogy": "Like a combination GPS and compass - tells you both direction and distance to the station.",
    "unit": "VOR Types",
    "tags": "facilities|VORTAC|military"
  },
  {
    "term": "VOR/DME",
    "definition": "A VOR facility co-located with Distance Measuring Equipment (DME). The DME operates on UHF frequencies (960-1215 MHz) and provides slant-range distance to the station, while VOR provides bearing information. Together they provide complete position fixing.",
    "analogy": "Like having both a compass and a rangefinder to pinpoint your exact location.",
    "unit": "VOR Types",
    "tags": "facilities|DME|navigation"
  },
  {
    "term": "DVOR (Doppler VOR)",
    "definition": "An advanced VOR system using Doppler effect instead of mechanical rotation to generate the variable phase signal. DVORs are more accurate and reliable than conventional VORs, with less site error and reduced maintenance requirements.",
    "analogy": "Like upgrading from a mechanical watch to a digital one - same function, better accuracy and reliability.",
    "unit": "VOR Types",
    "tags": "facilities|DVOR|technology"
  },
  {
    "term": "VOR Receiver Sensitivity",
    "definition": "The minimum signal strength required for the VOR receiver to provide usable navigation information, typically around 90 dBm (1 microvolt). Weak signals result in flag warnings and unreliable navigation data. Proper antenna installation and cable integrity are critical.",
    "analogy": "Like needing a minimum cell phone signal strength to make a clear call.",
    "unit": "VOR Receiver",
    "tags": "receiver|sensitivity|performance"
  },
  {
    "term": "VOR Antenna Placement",
    "definition": "VOR antennas must be mounted with clear line-of-sight to the horizon, typically on top of the vertical stabilizer or fuselage. Metallic obstructions can cause reflections and bearing errors. Balanced dipole or counterpoise antennas are commonly used.",
    "analogy": "Like mounting a TV antenna high and clear for best reception, away from metal that might cause interference.",
    "unit": "VOR Installation",
    "tags": "installation|antenna|maintenance"
  },
  {
    "term": "VOR Bearing Pointer (RMI)",
    "definition": "On a Radio Magnetic Indicator (RMI), the VOR bearing pointer automatically rotates to point toward the VOR station regardless of aircraft heading. This provides quick situational awareness without mental calculation of relative bearing.",
    "analogy": "Like a compass needle that always points to a specific landmark instead of magnetic north.",
    "unit": "VOR Instruments",
    "tags": "instruments|RMI|navigation"
  },
  {
    "term": "VOR Station Declination",
    "definition": "VOR radials are aligned with magnetic north at the time of station commissioning. However, magnetic variation changes over time, requiring periodic station re-alignment. The station broadcasts magnetic bearings, not true bearings.",
    "analogy": "Like having to update old maps because magnetic north slowly moves over the years.",
    "unit": "VOR Operations",
    "tags": "operations|magnetic_variation|accuracy"
  },
  {
    "term": "VOR Flag Alarm",
    "definition": "A visual warning (red flag or OFF indication) that appears when VOR signal reliability falls below acceptable limits due to weak signal, station outage, or receiver malfunction. Navigation using a flagged VOR is unreliable and prohibited for IFR flight.",
    "analogy": "Like a 'check engine' light for your navigation system - warns you when the system is not trustworthy.",
    "unit": "VOR Instruments",
    "tags": "instruments|warnings|safety"
  },
  {
    "term": "VOR Course Intercept",
    "definition": "The technique of intercepting a desired VOR radial by flying a heading that creates a measurable angle to the course. Common intercept angles are 30¬∞, 45¬∞, or 90¬∞ depending on distance from the station and urgency. As the needle centers, turn to track the radial.",
    "analogy": "Like merging onto a highway - you approach at an angle, then straighten out once you're on the road.",
    "unit": "VOR Navigation",
    "tags": "navigation|procedures|flight_techniques"
  },
  {
    "term": "VOR Reverse Sensing",
    "definition": "A navigation error that occurs when flying outbound from a VOR with the OBS set to the reciprocal course. The CDI needle deflects opposite to the correction needed. Always use FROM indication when flying away from a station to prevent reverse sensing.",
    "analogy": "Like backing up a car - the steering feels backwards until you adjust your mental model.",
    "unit": "VOR Navigation",
    "tags": "navigation|errors|procedures"
  },
  {
    "term": "VOR Scalloping",
    "definition": "Irregular course indications that occur when an aircraft is close to a VOR station, caused by the cone of confusion directly over the station. The TO/FROM indicator becomes unstable, and the CDI may oscillate. Normal operation resumes once clear of the station.",
    "analogy": "Like the dead spot directly under a water sprinkler where you can't tell which direction the water is coming from.",
    "unit": "VOR Operations",
    "tags": "operations|cone_of_confusion|limitations"
  },
  {
    "term": "VOR Propagation Characteristics",
    "definition": "VOR signals travel by line-of-sight and are subject to VHF propagation limitations. Terrain, buildings, and the curvature of the earth can block signals. Altitude increases reception range following the radio horizon formula: distance ‚âà 1.23 √ó ‚àöaltitude.",
    "analogy": "Like how you can see farther from a mountaintop - higher altitude equals better VOR reception range.",
    "unit": "VOR Fundamentals",
    "tags": "fundamentals|propagation|line_of_sight"
  },
  {
    "term": "VOR Cone of Confusion",
    "definition": "The area directly above a VOR station where signals are unreliable or absent. In this region, the TO/FROM indicator fluctuates or shows OFF, and bearing information is unusable. The cone typically extends from the station to about 3,000 feet AGL with a 50¬∞ apex angle.",
    "analogy": "Like standing directly under a lighthouse - you can't determine direction when you're right on top of it.",
    "unit": "VOR Operations",
    "tags": "operations|cone_of_confusion|limitations"
  },
  {
    "term": "VOR Checkpoint (Ground)",
    "definition": "A designated location on an airport where VOR receiver accuracy can be tested. The published radial and location are marked in the Chart Supplement. The receiver must indicate within ¬±4¬∞ of the published radial. Required for IFR flight every 30 days.",
    "analogy": "Like a marked spot in a parking lot where you can verify your compass reading against a known direction.",
    "unit": "VOR Testing",
    "tags": "testing|checkpoints|maintenance"
  },
  {
    "term": "VOR Checkpoint (Airborne)",
    "definition": "A designated point in flight where VOR bearing accuracy can be verified, typically over a prominent landmark at a specific altitude. The receiver must indicate within ¬±6¬∞ of the published radial. Used when ground checkpoints are not available.",
    "analogy": "Like using a known mountain peak to verify your compass heading while flying.",
    "unit": "VOR Testing",
    "tags": "testing|checkpoints|airborne"
  },
  {
    "term": "VOR Dual Check",
    "definition": "When two independent VOR receivers are installed, they can be tuned to the same VOR station for comparison. The indicated bearings must agree within 4¬∞ of each other. This is an acceptable alternative to VOT, ground, or airborne checkpoints.",
    "analogy": "Like comparing two thermometers to make sure they both read the same temperature.",
    "unit": "VOR Testing",
    "tags": "testing|dual_check|procedures"
  },
  {
    "term": "VOR Site Error",
    "definition": "Bearing inaccuracies caused by terrain reflections, buildings, or other obstructions near the VOR ground station. Site errors are minimized during station installation through careful siting and calibration flights. DVORs are less susceptible to site errors than conventional VORs.",
    "analogy": "Like how mountains can create echoes - nearby obstacles can reflect VOR signals and cause false readings.",
    "unit": "VOR Errors",
    "tags": "errors|site_error|accuracy"
  },
  {
    "term": "VOR Quadrantal Error",
    "definition": "Aircraft-induced errors caused by VOR signal reflection off the aircraft structure, varying with aircraft heading. This error follows a predictable pattern in 90¬∞ quadrants. Proper antenna placement and compass calibration minimize quadrantal error.",
    "analogy": "Like how your car's metal body can affect compass readings differently depending on which direction you're facing.",
    "unit": "VOR Errors",
    "tags": "errors|aircraft_error|installation"
  },
  {
    "term": "VOR Course Sensitivity",
    "definition": "The angular deviation per dot on the CDI is constant at approximately 2¬∞ per dot regardless of distance from the station. This means course width increases with distance (200 ft/NM √ó distance). Close to the station, small heading changes cause large needle movements.",
    "analogy": "Like the expanding beam of a flashlight - the farther away you are, the wider the coverage area becomes.",
    "unit": "VOR Navigation",
    "tags": "navigation|sensitivity|course_width"
  },
  {
    "term": "VOR Monitor System",
    "definition": "Automated equipment at VOR ground stations that continuously checks signal integrity, bearing accuracy, and transmitter power. If parameters exceed tolerances, the monitor automatically removes the identifier or shuts down the station to prevent unreliable navigation.",
    "analogy": "Like a smoke detector that automatically alerts when something is wrong with the system.",
    "unit": "VOR Facilities",
    "tags": "facilities|monitoring|safety"
  },
  {
    "term": "VOR Navigation Logging",
    "definition": "FAA requires that VOR receiver checks be logged with: date, place, bearing error, and technician signature. Logs must be retained and available for inspection. Required every 30 days for IFR operations under FAR 91.171.",
    "analogy": "Like keeping a maintenance log for your car - proving the equipment has been properly checked.",
    "unit": "VOR Testing",
    "tags": "testing|documentation|regulations"
  },
  {
    "term": "VOR Localizer Frequency Pairing",
    "definition": "In the 108.0-111.95 MHz range, VOR and ILS localizer frequencies are interleaved. Even tenth frequencies (108.1, 108.3, etc.) are typically localizers, while odd tenth frequencies are VORs. Modern receivers automatically recognize the signal type.",
    "analogy": "Like how AM and FM radio stations share spectrum space - VOR and ILS take turns using frequencies.",
    "unit": "VOR Fundamentals",
    "tags": "fundamentals|ILS|frequencies"
  }
  ];

  function uidFrom(str){
    let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0 }
    return Math.abs(h).toString(36);
  }
  function normalizeTags(t){
    if(Array.isArray(t)) return t.map(s=>String(s).trim()).filter(Boolean);
    if(typeof t === 'string') return t.split(/[|,]/).map(s=>s.trim()).filter(Boolean);
    return [];
  }
  const DATA = FIXED_CARDS.map(c=>({ ...c, id: uidFrom(c.term+'::'+c.definition), tags: normalizeTags(c.tags) }));

  // ---------- Storage ----------
  const LS_KEY = 'glossary.mastery';
  function loadMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{ return {} } }
  function saveMap(m){ try{ localStorage.setItem(LS_KEY, JSON.stringify(m)) }catch{} }

  // ---------- SM-2 ----------
  const DAY = 24*60*60*1000;
  function scheduleNext(state, rating){
    const q = rating==='difficult'?2: rating==='medium'?4:5;
    let { reps=0, ivl=0, ease=2.5 } = state||{};
    const now = Date.now();
    if(q < 3){ reps=0; ivl=1; }
    else { if(reps===0) ivl=1; else if(reps===1) ivl=6; else ivl=Math.max(1, Math.round(ivl*ease)); reps+=1; }
    ease = Math.max(1.3, ease + 0.1 - (5-q)*(0.08 + (5-q)*0.02));
    const due = now + ivl*DAY;
    return { ...state, rating, reps, ivl, ease, due, last: now };
  }

  // ---------- State ----------
  const state = {
    mastery: loadMap(),
    deck: 'all',
    query: '',
    tags: new Set(),
    idx: 0,
    flipped: false
  };

  // ---------- Elements ----------
  const $front = document.getElementById('front');
  const $back = document.getElementById('back');
  const $flip = document.getElementById('flip');
  const $list = document.getElementById('list');
  const $tags = document.getElementById('tags');
  const $search = document.getElementById('search');
  const $prev = document.getElementById('prev');
  const $next = document.getElementById('next');
  const $rateEasy = document.getElementById('rateEasy');
  const $rateMedium = document.getElementById('rateMedium');
  const $rateDifficult = document.getElementById('rateDifficult');
  const $chips = Array.from(document.querySelectorAll('.deck-switch .chip'));
  const $counts = {
    easy: document.querySelector('[data-count="easy"]'),
    medium: document.querySelector('[data-count="medium"]'),
    difficult: document.querySelector('[data-count="difficult"]')
  };

  // ---------- Derived ----------
  function filtered(){
    const q = state.query.trim().toLowerCase();
    const base = DATA;
    const byQ = q ? base.filter(d => (d.term||'').toLowerCase().includes(q) || (d.definition||'').toLowerCase().includes(q) || (d.unit||'').toLowerCase().includes(q) || (d.tags||[]).some(t=>t.toLowerCase().includes(q))) : base;
    const byTags = state.tags.size ? byQ.filter(d => (d.tags||[]).some(t=>state.tags.has(t))) : byQ;
    const byDeck = state.deck==='all' ? byTags : byTags.filter(d => (state.mastery[d.id]?.rating||'medium') === state.deck);
    return byDeck;
  }

  function computeTagIndex(){
    const counts = {};
    DATA.forEach(it => (it.tags||[]).forEach(t => { if(!t) return; counts[t]=(counts[t]||0)+1; }));
    return Object.entries(counts).sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])));
  }

  function computeCounts(){
    const easy = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='easy').length;
    const med  = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='medium').length;
    const dif  = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='difficult').length;
    $counts.easy.textContent = `(${easy})`;
    $counts.medium.textContent = `(${med})`;
    $counts.difficult.textContent = `(${dif})`;
  }

  // ---------- Render ----------
  function renderCard(){
    const items = filtered();
    if(items.length===0){
      $front.innerHTML = `<div class="empty">No terms match your search or selected tags.</div>`;
      $back.innerHTML = '';
      return;
    }
    if(state.idx >= items.length) state.idx = 0;
    const cur = items[state.idx];
    const rating = (state.mastery[cur.id]?.rating)||'medium';
    $front.innerHTML = `
      <div>
        <div class="meta">Term</div>
        <div class="term">${escapeHTML(cur.term)}</div>
        <div class="unit">${escapeHTML(cur.unit||'')}</div>
        <div style="margin-top:8px">${(cur.tags||[]).map(t=>`<span class="badge">${escapeHTML(t)}</span>`).join('')}</div>
      </div>`;
    $back.innerHTML = `
      <div>
        <div class="meta">Definition</div>
        <div class="def">${escapeHTML(cur.definition)}</div>
      </div>`;

    setActive($rateEasy, rating==='easy');
    setActive($rateMedium, rating==='medium');
    setActive($rateDifficult, rating==='difficult');
  }

  function renderList(){
    const items = filtered();
    if(items.length===0){ $list.innerHTML = `<div class="empty">No terms match your search or selected tags.</div>`; return; }
    $list.innerHTML = items.map(it=>{
      const r = (state.mastery[it.id]?.rating)||'medium';
      const color = r==='easy' ? 'background:var(--green);color:#fff' : r==='medium' ? 'background:var(--yellow);color:#fff' : 'background:var(--red);color:#fff';
      return `<div class="list-item">
        <div class="title">${escapeHTML(it.term)}</div>
        <div class="line">${escapeHTML(it.definition)}</div>
        <div class="line">${escapeHTML(it.unit||'')}${(it.tags||[]).length?' ‚Ä¢ ':''}${(it.tags||[]).map(escapeHTML).join(', ')}</div>
        <div class="line"><span class="badge" style="${color}">${r[0].toUpperCase()+r.slice(1)}</span></div>
      </div>`
    }).join('');
  }

  function renderTags(){
    const idx = computeTagIndex();
    $tags.innerHTML = idx.slice(0,24).map(([tag,count])=>{
      const active = state.tags.has(tag);
      return `<button class="tag ${active?'active':''}" data-tag="${encodeURIComponent(tag)}">${escapeHTML(tag)} <span style="opacity:.7">(${count})</span></button>`;
    }).join('') + (state.tags.size? ' <button class="tag" id="clearTags">Clear</button>': '');
  }

  function renderAll(){
    computeCounts();
    renderCard();
    renderList();
    renderTags();
  }

  // ---------- Utils ----------
  function setActive(btn, on){
    const classes = btn.className.split(' ').filter(Boolean);
    const has = classes.includes('active');
    if(on && !has) btn.className += ' active';
    if(!on && has) btn.className = classes.filter(c=>c!=='active').join(' ');
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }

  // ---------- Events ----------
  $flip.addEventListener('click', ()=>{ state.flipped=!state.flipped; $flip.classList.toggle('is-flipped', state.flipped); });
  $prev.addEventListener('click', ()=>{ const len=filtered().length||1; state.flipped=false; state.idx=(state.idx-1+len)%len; renderCard(); });
  $next.addEventListener('click', ()=>{ const len=filtered().length||1; state.flipped=false; state.idx=(state.idx+1)%len; renderCard(); });

  $rateEasy.addEventListener('click', ()=>rate('easy'));
  $rateMedium.addEventListener('click', ()=>rate('medium'));
  $rateDifficult.addEventListener('click', ()=>rate('difficult'));

  $chips.forEach(ch=> ch.addEventListener('click', ()=>{
    $chips.forEach(b=>b.classList.remove('active'));
    ch.classList.add('active');
    state.deck = ch.dataset.deck;
    state.idx = 0; state.flipped=false; $flip.classList.remove('is-flipped');
    renderAll();
  }));

  $tags.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-tag]');
    if(t){
      const tag = decodeURIComponent(t.getAttribute('data-tag'));
      if(state.tags.has(tag)) state.tags.delete(tag); else state.tags.add(tag);
      state.idx=0; state.flipped=false; $flip.classList.remove('is-flipped');
      renderAll();
    }
    if(e.target && e.target.id==='clearTags'){ state.tags.clear(); renderAll(); }
  });

  $search.addEventListener('input', ()=>{ state.query = $search.value; state.idx=0; renderAll(); });

  window.addEventListener('keydown', (e)=>{
    const tag = (e.target && e.target.tagName||'').toLowerCase();
    if(tag==='input' || tag==='textarea') return;
    if(e.code==='ArrowLeft'){ e.preventDefault(); $prev.click(); }
    if(e.code==='ArrowRight'){ e.preventDefault(); $next.click(); }
    if(e.code==='Space'){ e.preventDefault(); $flip.click(); }
  });

  function rate(level){
    const items = filtered(); if(items.length===0) return;
    const cur = items[state.idx];
    const st = state.mastery[cur.id] || { rating:'medium', seen:0, correct:0, last:0, reps:0, ivl:0, ease:2.5, due:0 };
    const next = scheduleNext(st, level);
    state.mastery[cur.id] = next; saveMap(state.mastery);
    computeCounts();
    $next.click();
  }

  // ---------- Init ----------
  DATA.forEach(it=>{ if(!state.mastery[it.id]) state.mastery[it.id] = { rating:'medium', seen:0, correct:0, last:0, reps:0, ivl:0, ease:2.5, due:0 }; });
  saveMap(state.mastery);
  renderAll();

  // ---------- Finish Session & Report to Parent ----------
  function finishSession() {
    // Calculate score based on mastery ratings
    const total = DATA.length;
    const easy = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='easy').length;
    const medium = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='medium').length;
    const difficult = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='difficult').length;

    // Score: easy cards = 100%, medium = 50%, difficult = 0%
    const score = Math.round((easy + medium * 0.5) / total * 100);

    // Try to send to parent page
    try {
      if (window.parent && window.parent.completeModule) {
        console.log('‚úÖ Sending flashcards score to parent page:', score + '%');
        window.parent.completeModule('flashcards', score);

        alert(`üìö Study Session Complete!\n\nYour Progress:\n‚úÖ Easy: ${easy} cards\n‚ö†Ô∏è Medium: ${medium} cards\n‚ùå Difficult: ${difficult} cards\n\nüìä Score: ${score}%\n\nKeep studying to improve!`);

        // Return to home view after 1 second
        setTimeout(() => {
          if (window.parent && window.parent.showTab) {
            window.parent.showTab('home');
          }
        }, 1000);
      } else {
        console.log('‚ö†Ô∏è Parent page not available - running standalone');
        alert(`üìö Study Session Complete!\n\nYour Progress:\n‚úÖ Easy: ${easy} cards\n‚ö†Ô∏è Medium: ${medium} cards\n‚ùå Difficult: ${difficult} cards\n\nüìä Score: ${score}%\n\n(Gamification not available in standalone mode)`);
      }
    } catch (e) {
      console.error('Error communicating with parent page:', e);
      alert(`üìö Study Session Complete!\n\nScore: ${score}%\nEasy: ${easy}, Medium: ${medium}, Difficult: ${difficult}`);
    }
  }

  // Attach finish session button handler
  const $finishBtn = document.getElementById('finishSession');
  if ($finishBtn) {
    $finishBtn.addEventListener('click', finishSession);
  }

  // ---------- Lightweight tests (no special chars) ----------
  ;(function runTests(){
    try{
      if(!(Array.isArray(DATA) && DATA.length>0)) console.error('Test failed: dataset missing');
      const total = DATA.length;
      const counts = ['easy','medium','difficult'].map(k=> DATA.filter(d => (state.mastery[d.id]?.rating||'medium')===k).length).reduce((a,b)=>a+b,0);
      if(!(counts<=total)) console.error('Test failed: deck counts');
    }catch(e){ console.error('Self-test error', e); }
  })();
})();
</script>
</body>
</html>
